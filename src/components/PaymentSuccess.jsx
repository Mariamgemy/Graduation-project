import React, { useState, useEffect } from "react";
import { useNavigate, useLocation } from "react-router-dom";
import {
  FaCheckCircle,
  FaFileInvoice,
  FaHome,
  FaHeadset,
  FaClock,
  FaHashtag,
  FaLightbulb,
  FaEnvelope,
  FaShieldAlt,
  FaDownload,
} from "react-icons/fa";
import "../Css/PaymentSuccess.css";
import jsPDF from "jspdf";
import html2canvas from "html2canvas";

function EnhancedSuccessMessage({
  paymentResult,
  paymentData,
  formData,
  card,
  onDownloadReceipt,
  onContactSupport,
}) {
  const navigate = useNavigate();
  const [showConfetti, setShowConfetti] = useState(true);

  useEffect(() => {
    // ุฅุฎูุงุก ุงููููููุชู ุจุนุฏ 3 ุซูุงู
    const timer = setTimeout(() => {
      setShowConfetti(false);
    }, 3000);

    return () => clearTimeout(timer);
  }, []);

  const getUtilityType = (title) => {
    if (title?.includes("ููุฑุจุงุก")) return "ููุฑุจุงุก";
    if (title?.includes("ููุงู")) return "ููุงู";
    if (title?.includes("ุบุงุฒ")) return "ุบุงุฒ";
    if (
      title?.includes("ูุฑูุฑ") ||
      title?.includes("ุฑุฎุตุฉ") ||
      title?.includes("ููุฑุฎุต") ||
      title === "ุฎุฏูุงุช ุงููุฑูุฑ"
    )
      return "ุฎุฏูุงุช ุงููุฑูุฑ";
    if (title?.includes("ูุฎุงููุงุช")) return "ูุฎุงููุงุช ุงููุฑูุฑ";
    return "ุฎุฏูุฉ ุฃุฎุฑู";
  };

  const getCurrentDateTime = () => {
    const now = new Date();
    return {
      date: now.toLocaleDateString("ar-EG"),
      time: now.toLocaleTimeString("ar-EG", {
        hour: "2-digit",
        minute: "2-digit",
      }),
    };
  };

  const { date, time } = getCurrentDateTime();

  const handleGoHome = () => {
    navigate("/");
  };

  const handleDownloadReceipt = () => {
    if (onDownloadReceipt) {
      onDownloadReceipt();
    } else {
      // ููุทู ุงูุชุฑุงุถู ูุชุญููู ุงูุฅูุตุงู
      console.log("ุชุญููู ุงูุฅูุตุงู...");
    }
  };

  const handleContactSupport = () => {
    if (onContactSupport) {
      onContactSupport();
    } else {
      // ููุทู ุงูุชุฑุงุถู ููุชูุงุตู ูุน ุงูุฏุนู
      console.log("ุงูุชูุงุตู ูุน ุงูุฏุนู...");
    }
  };

  return (
    <div className="success-page-container">
      {/* ูุณู ุงูุงุญุชูุงู ุจุงููุฌุงุญ */}
      <div className="success-celebration">
        <div className="success-icon-large bounce-in">
          <FaCheckCircle />
        </div>
        <h1 className="success-title-large">ุชู ุงูุฏูุน ุจูุฌุงุญ!</h1>
        <p className="success-subtitle">ุดูุฑุงู ูู ุนูู ุงุณุชุฎุฏุงู ุฎุฏูุงุชูุง</p>
      </div>

      {/* ุจุทุงูุฉ ููุฎุต ุงูุฏูุน */}
      <div className="payment-summary-card fade-in-up">
        <div className="payment-summary-header">
          <div className="payment-summary-icon">
            <FaFileInvoice />
          </div>
          <h2 className="payment-summary-title">ููุฎุต ุนูููุฉ ุงูุฏูุน</h2>
        </div>

        <div className="payment-details-grid">
          <div className="payment-detail-item">
            <span className="payment-detail-label">ููุน ุงูุฎุฏูุฉ</span>
            <span className="payment-detail-value">
              {getUtilityType(card?.title)}
            </span>
          </div>

          <div className="payment-detail-item">
            <span className="payment-detail-label">ุงูุฑูู ุงููููู</span>
            <span className="payment-detail-value">
              {formData?.NID || formData?.userData?.nationalId || "ุบูุฑ ูุญุฏุฏ"}
            </span>
          </div>

          {/* ุนุฑุถ ุงุณู ุงููุณุชุฎุฏู ูุฎุฏูุงุช ุงููุฑูุฑ */}
          {formData?.userData?.name && (
            <div className="payment-detail-item">
              <span className="payment-detail-label">ุงุณู ุงููุณุชุฎุฏู</span>
              <span className="payment-detail-value">
                {formData.userData.name}
              </span>
            </div>
          )}

          {/* ุนุฑุถ ูุฑุงุกุฉ ุงูุนุฏุงุฏ ููุท ููุฎุฏูุงุช ุงูุชู ุชุญุชุงุฌูุง */}
          {(card?.title?.includes("ููุฑุจุงุก") ||
            card?.title?.includes("ููุงู") ||
            card?.title?.includes("ุบุงุฒ")) && (
            <div className="payment-detail-item">
              <span className="payment-detail-label">ูุฑุงุกุฉ ุงูุนุฏุงุฏ</span>
              <span className="payment-detail-value">
                {formData?.currentReading || "ุบูุฑ ูุญุฏุฏ"}
              </span>
            </div>
          )}

          {(paymentData?.billNumber || paymentResult?.billNumber) && (
            <div className="payment-detail-item">
              <span className="payment-detail-label">ุฑูู ุงููุงุชูุฑุฉ</span>
              <span className="payment-detail-value">
                #{paymentData?.billNumber || paymentResult?.billNumber}
              </span>
            </div>
          )}

          {/* ุนุฑุถ ููุฏ ุงูุฏูุน ูุฎุฏูุงุช ุงููุฑูุฑ */}
          {paymentData?.paymentCode && (
            <div className="payment-detail-item">
              <span className="payment-detail-label">ููุฏ ุงูุฏูุน</span>
              <span className="payment-detail-value">
                {paymentData.paymentCode}
              </span>
            </div>
          )}
        </div>

        {(paymentData?.amount || paymentResult?.amount) && (
          <div className="payment-amount-highlight">
            <div className="payment-amount-label">ุงููุจูุบ ุงููุฏููุน</div>
            <h3 className="payment-amount-value">
              {paymentData?.amount || paymentResult?.amount} ุฌููู
            </h3>
          </div>
        )}
      </div>

      {/* ุชูุงุตูู ุงูุนูููุฉ */}
      <div className="transaction-details fade-in-up">
        <div className="transaction-header">
          <div className="transaction-icon">
            <FaHashtag />
          </div>
          <h3 className="transaction-title">ุชูุงุตูู ุงูุนูููุฉ</h3>
        </div>

        <div className="transaction-info">
          {(paymentResult?.transactionId ||
            paymentResult?.paymentIntentId ||
            paymentData?.paymentIntentId) && (
            <div className="transaction-item">
              <span className="transaction-label">ุฑูู ุงููุฑุฌุน</span>
              <span className="transaction-value">
                {paymentResult?.transactionId ||
                  paymentResult?.paymentIntentId ||
                  paymentData?.paymentIntentId}
              </span>
            </div>
          )}

          <div className="transaction-item">
            <span className="transaction-label">ุชุงุฑูุฎ ุงูุนูููุฉ</span>
            <span className="transaction-value">
              {paymentResult?.date || date}
            </span>
          </div>

          <div className="transaction-item">
            <span className="transaction-label">ููุช ุงูุนูููุฉ</span>
            <span className="transaction-value">{time}</span>
          </div>

          <div className="transaction-item">
            <span className="transaction-label">ุญุงูุฉ ุงูุนูููุฉ</span>
            <span className="transaction-value" style={{ color: "#10b981" }}>
              โ ููุชููุฉ
            </span>
          </div>
        </div>
      </div>

      {/* ุฃุฒุฑุงุฑ ุงูุฅุฌุฑุงุกุงุช */}
      <div className="success-actions fade-in-up">
        <button
          className="action-button-primary"
          onClick={handleDownloadReceipt}
        >
          <FaDownload />
          ุชุญููู ุงูุฅูุตุงู
        </button>

        <button className="action-button-secondary" onClick={handleGoHome}>
          <FaHome />
          ุงูุนูุฏุฉ ููุฑุฆูุณูุฉ
        </button>

        <button
          className="action-button-support"
          onClick={handleContactSupport}
        >
          <FaHeadset />
          ุงูุฏุนู ุงูููู
        </button>
      </div>

      {/* ูุตุงุฆุญ ููุนูููุงุช ูููุฏุฉ */}
      <div className="success-tips fade-in-up">
        <div className="tips-header">
          <div className="tips-icon">
            <FaLightbulb />
          </div>
          <h4 className="tips-title">ูุนูููุงุช ูููุฉ</h4>
        </div>

        <ul className="tips-list">
          <li className="tips-item">
            <span className="tips-item-icon">๐ก</span>
            ุงุญุชูุธ ุจุฑูู ุงููุฑุฌุน ูููุชุงุจุนุฉ ุงููุณุชูุจููุฉ
          </li>
          <li className="tips-item">
            <span className="tips-item-icon">๐ง</span>
            ุชุญูู ูู ุจุฑูุฏู ุงูุฅููุชุฑููู ููุญุตูู ุนูู ุงูุฅูุตุงู
          </li>
          <li className="tips-item">
            <span className="tips-item-icon">๐</span>
            ุฌููุน ูุนุงููุงุชู ูุญููุฉ ููุดูุฑุฉ ุจุฃุนูู ูุนุงููุฑ ุงูุฃูุงู
          </li>
          <li className="tips-item">
            <span className="tips-item-icon">โฐ</span>
            ุณูุชู ุชุญุฏูุซ ุญุณุงุจู ุฎูุงู ุฏูุงุฆู ููููุฉ
          </li>
        </ul>
      </div>
    </div>
  );
}

// ูุธููุฉ ุฅูุดุงุก PDF ุจุชุตููู ุฌููู
function createBeautifulPDF(paymentData, paymentResult, formData, card) {
  const doc = new jsPDF();

  // ุฅุนุฏุงุฏ ุงูุฎุท ููุนุฑุจูุฉ - ุงุณุชุฎุฏุงู ุฎุท ูุฏุนู ุงูุนุฑุจูุฉ
  try {
    doc.setFont("helvetica");
  } catch (error) {
    console.warn("Font setting failed, using default");
  }

  // ุฃููุงู ุฌูููุฉ
  const primaryColor = [52, 152, 219]; // ุฃุฒุฑู ุฌููู
  const secondaryColor = [155, 89, 182]; // ุจููุณุฌู
  const successColor = [46, 204, 113]; // ุฃุฎุถุฑ
  const textColor = [52, 73, 94]; // ุฑูุงุฏู ุฏุงูู
  const lightGray = [236, 240, 241]; // ุฑูุงุฏู ูุงุชุญ

  // ุฅุถุงูุฉ ุดุฑูุท ุนููู ูููู
  doc.setFillColor(...primaryColor);
  doc.rect(0, 0, 210, 25, "F");

  // ุฅุถุงูุฉ ุดุฑูุท ุซุงููู
  doc.setFillColor(...secondaryColor);
  doc.rect(0, 25, 210, 5, "F");

  // ุนููุงู ุงูุฅูุตุงู - ุจุงููุบุฉ ุงูุฅูุฌููุฒูุฉ ูุชุฌูุจ ูุดุงูู ุงูุนุฑุจูุฉ
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(20);
  doc.setFont("helvetica", "bold");
  doc.text("Payment Receipt", 105, 18, { align: "center" });

  // ูุนูููุงุช ุงูุดุฑูุฉ
  doc.setTextColor(...textColor);
  doc.setFontSize(12);
  doc.setFont("helvetica", "normal");
  doc.text("Digital Bills Payment Platform", 105, 40, { align: "center" });

  // ุฎุท ูุงุตู
  doc.setDrawColor(...lightGray);
  doc.setLineWidth(1);
  doc.line(20, 50, 190, 50);

  // ุชูุงุตูู ุงููุงุชูุฑุฉ ูู ุตูุฏูู
  doc.setFillColor(...lightGray);
  doc.roundedRect(20, 60, 170, 80, 3, 3, "F");

  // ุนููุงู ุงูุชูุงุตูู
  doc.setTextColor(...primaryColor);
  doc.setFontSize(16);
  doc.setFont("helvetica", "bold");
  doc.text("Bill Details", 105, 75, { align: "center" });

  // ุงูุชูุงุตูู
  doc.setTextColor(...textColor);
  doc.setFontSize(11);
  doc.setFont("helvetica", "normal");

  const getCurrentDateTime = () => {
    const now = new Date();
    return {
      date:
        now.getDate().toString().padStart(2, "0") +
        "/" +
        (now.getMonth() + 1).toString().padStart(2, "0") +
        "/" +
        now.getFullYear(),
      time:
        now.getHours().toString().padStart(2, "0") +
        ":" +
        now.getMinutes().toString().padStart(2, "0"),
    };
  };

  const { date, time } = getCurrentDateTime();

  const details = [
    {
      label: "Service Type",
      value: card?.title ? translateServiceType(card.title) : "Not specified",
    },
    { label: "National ID", value: formData?.NID || "Not specified" },
    {
      label: "Meter Reading",
      value: formData?.currentReading || "Not specified",
    },
    {
      label: "Bill Number",
      value:
        paymentData?.billNumber || paymentResult?.billNumber || "Not available",
    },
    { label: "Transaction Date", value: date }, // ุงุณุชุฎุฏู ุงูุชุงุฑูุฎ ุงูุฅูุฌููุฒู ููุท
    { label: "Transaction Time", value: time },
    {
      label: "Reference Number",
      value: (
        paymentResult?.transactionId ||
        paymentResult?.paymentIntentId ||
        paymentData?.paymentIntentId ||
        "Not available"
      ).toString(),
    },
  ];

  let yPosition = 90;
  details.forEach((detail, index) => {
    if (index % 2 === 0) {
      // ุฎูููุฉ ูุชูุงูุจุฉ
      doc.setFillColor(248, 249, 250);
      doc.rect(25, yPosition - 5, 160, 12, "F");
    }

    doc.setFont("helvetica", "bold");
    doc.setTextColor(...primaryColor);
    doc.text(detail.label + ":", 30, yPosition);

    doc.setFont("helvetica", "normal");
    doc.setTextColor(...textColor);
    // ุงูุชุฃูุฏ ูู ุฃู ุงููููุฉ ูุต ูููุณ undefined
    const value = detail.value ? detail.value.toString() : "Not available";
    doc.text(value, 80, yPosition);

    yPosition += 12;
  });

  // ุงููุจูุบ ุงููุฏููุน ูู ุตูุฏูู ูููุฒ
  const amount = paymentData?.amount || paymentResult?.amount || "0";
  doc.setFillColor(...successColor);
  doc.roundedRect(20, yPosition + 10, 170, 25, 3, 3, "F");

  doc.setTextColor(255, 255, 255);
  doc.setFontSize(14);
  doc.setFont("helvetica", "bold");
  doc.text("Amount Paid", 105, yPosition + 20, { align: "center" });

  doc.setFontSize(18);
  doc.text(amount + " EGP", 105, yPosition + 30, { align: "center" });

  // ุญุงูุฉ ุงูุนูููุฉ
  doc.setFillColor(212, 237, 218);
  doc.roundedRect(20, yPosition + 45, 170, 15, 3, 3, "F");

  doc.setTextColor(...successColor);
  doc.setFontSize(12);
  doc.setFont("helvetica", "bold");
  doc.text("โ Payment Successful", 95, yPosition + 55, { align: "center" });

  // ุฑุณุงูุฉ ุดูุฑ
  doc.setTextColor(...textColor);
  doc.setFontSize(10);
  doc.setFont("helvetica", "normal");
  doc.text("Thank you for using our digital platform", 105, yPosition + 75, {
    align: "center",
  });
  doc.text("Please keep this receipt for your records", 105, yPosition + 85, {
    align: "center",
  });

  // ุดุฑูุท ุณููู
  doc.setFillColor(...primaryColor);
  doc.rect(0, 285, 210, 10, "F");

  // ุฑูู ุงูุตูุญุฉ ูุงูุชุงุฑูุฎ
  doc.setTextColor(...lightGray);
  doc.setFontSize(8);
  doc.text("Generated on: " + date + " at " + time, 20, 280);
  doc.text("Page 1 of 1", 190, 280, { align: "right" });

  // ุญูุธ ุงูููู
  const fileName = `receipt_${
    paymentData?.billNumber || paymentResult?.billNumber || Date.now()
  }.pdf`;
  doc.save(fileName);
}

// ูุธููุฉ ูุณุงุนุฏุฉ ูุชุฑุฌูุฉ ููุน ุงูุฎุฏูุฉ
function translateServiceType(serviceType) {
  if (serviceType?.includes("ููุฑุจุงุก")) return "Electricity";
  if (serviceType?.includes("ููุงู")) return "Water";
  if (serviceType?.includes("ุบุงุฒ")) return "Gas";
  if (serviceType?.includes("ูุฑูุฑ") || serviceType?.includes("ุฑุฎุตุฉ"))
    return "Traffic Services";
  if (serviceType?.includes("ูุฎุงููุงุช")) return "Traffic Violations";
  return serviceType || "Other Service";
}

// ุงููููู ุงูุฑุฆูุณู ุงูููุญุฏูุซ
function PaymentSuccess() {
  const location = useLocation();
  const navigate = useNavigate();

  // ุงุณุชุฎุฑุงุฌ ุงูุจูุงูุงุช ูู state
  const { state } = location;

  // ุงูุจูุงูุงุช ูููู ุฃู ุชุฃุชู ูู ูุตุงุฏุฑ ูุฎุชููุฉ ุญุณุจ ุทุฑููุฉ ุงูุชูุฑูุฑ
  const paymentResult = state?.paymentResult || state?.paymentDetails || {};
  const paymentData = state?.paymentData || state?.paymentDetails || {};
  const formData = state?.formData || {};
  const card = state?.card || {};

  console.log("PaymentSuccess - Received state:", state);
  console.log("PaymentSuccess - PaymentResult:", paymentResult);
  console.log("PaymentSuccess - PaymentData:", paymentData);
  console.log("PaymentSuccess - FormData:", formData);
  console.log("PaymentSuccess - Card:", card);

  // ูู ุญุงูุฉ ุนุฏู ูุฌูุฏ ุจูุงูุงุชุ ุฅุนุงุฏุฉ ุชูุฌูู ููุตูุญุฉ ุงูุฑุฆูุณูุฉ
  useEffect(() => {
    if (!state || (!paymentResult && !paymentData)) {
      console.warn(
        "PaymentSuccess - No payment data found, redirecting to home"
      );
      navigate("/");
    }
  }, [state, paymentResult, paymentData, navigate]);

  return (
    <EnhancedSuccessMessage
      paymentResult={paymentResult}
      paymentData={paymentData}
      formData={formData}
      card={card}
      onDownloadReceipt={() => {
        // ุฅูุดุงุก PDF ุจุชุตููู ุฌููู
        createBeautifulPDF(paymentData, paymentResult, formData, card);
      }}
      onContactSupport={() => {
        // ูููู ุชุฎุตูุต ูุฐู ุงููุธููุฉ ุญุณุจ ุงูุญุงุฌุฉ
        alert("ุณูุชู ุชูุฌููู ูุตูุญุฉ ุงูุฏุนู ุงูููู");
      }}
    />
  );
}

export default PaymentSuccess;
export { EnhancedSuccessMessage };
